<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Jiaobei · Night Ritual</title>

<style>
:root{
  --gold: rgba(246,210,122,0.92);
  --gold2: rgba(217,169,75,0.92);
  --ink: rgba(255,255,255,0.92);
  --muted: rgba(255,255,255,0.72);
  --shadow: 0 18px 55px rgba(0,0,0,0.62);
}

html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",system-ui,sans-serif;
  color:var(--ink);
  background:#000;
}

/* Cinematic background: slow focus */
.bg{
  position:fixed; inset:0;
  background:url("backgorund.jpg") center/cover no-repeat;
  transform: scale(1.06);
  filter: blur(10px) brightness(.68) saturate(1.08) contrast(1.07);
  animation: focusIn 1300ms cubic-bezier(.2,.9,.2,1) forwards;
}
@keyframes focusIn{
  to{
    filter: blur(0px) brightness(.72) saturate(1.08) contrast(1.07);
  }
}

/* Night vignette + glass */
.overlay{
  position:fixed; inset:0;
  background:
    radial-gradient(900px 520px at 50% 36%, rgba(0,0,0,0.22), rgba(0,0,0,0.72)),
    radial-gradient(800px 500px at 50% 85%, rgba(0,0,0,0.25), rgba(0,0,0,0.78)),
    linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.70));
  backdrop-filter: blur(2px);
}

/* Subtle mist (very low-key) */
.mist{
  position:fixed; inset:-12%;
  pointer-events:none;
  opacity:0.42;
  background:
    radial-gradient(260px 180px at 18% 30%, rgba(255,220,150,.10), transparent 70%),
    radial-gradient(320px 210px at 78% 36%, rgba(190,210,255,.08), transparent 72%),
    radial-gradient(280px 200px at 45% 85%, rgba(255,220,150,.07), transparent 72%);
  filter: blur(16px);
  animation: mistDrift 16s ease-in-out infinite;
}
@keyframes mistDrift{
  0%{ transform: translate3d(-1.2%, -1.0%, 0) scale(1); }
  50%{ transform: translate3d(1.8%, 1.4%, 0) scale(1.03); }
  100%{ transform: translate3d(-1.2%, -1.0%, 0) scale(1); }
}

/* Main */
.wrap{
  position:relative;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: env(safe-area-inset-top) 18px env(safe-area-inset-bottom) 18px;
}

.stage{
  width:min(520px, 92vw);
  text-align:center;
  transform: translateY(8px);
  animation: enter 900ms cubic-bezier(.2,.9,.2,1) both;
}
@keyframes enter{
  from{ opacity:0; transform: translateY(26px) scale(.985); }
  to{ opacity:1; transform: translateY(8px) scale(1); }
}

.title{
  margin:0 0 6px;
  font-size: 22px;
  letter-spacing:.18em;
  text-shadow: 0 14px 40px rgba(0,0,0,.55);
}
.subtitle{
  margin:0 0 26px;
  font-size: 13px;
  color:var(--muted);
  letter-spacing:.08em;
}

/* Simple gold ring (preferred) */
.ring{
  position:absolute;
  left:50%;
  top: 44%;
  transform: translate(-50%,-50%);
  width:min(320px, 82vw);
  aspect-ratio:1/1;
  border-radius:999px;
  pointer-events:none;
  opacity:0;

  border:2px solid rgba(255,215,120,0.65);
  box-shadow:
    0 0 22px rgba(246,210,122,0.24),
    0 0 70px rgba(246,210,122,0.12);
}

.ring.on{
  opacity:1;
  animation: ringSpin 6s linear infinite, ringPulse 1.7s ease-in-out infinite;
}

@keyframes ringSpin{
  from{ transform: translate(-50%,-50%) rotate(0deg); }
  to{ transform: translate(-50%,-50%) rotate(360deg); }
}
@keyframes ringPulse{
  0%{ box-shadow: 0 0 18px rgba(246,210,122,0.22), 0 0 60px rgba(246,210,122,0.10); }
  50%{ box-shadow: 0 0 28px rgba(246,210,122,0.35), 0 0 90px rgba(246,210,122,0.16); }
  100%{ box-shadow: 0 0 18px rgba(246,210,122,0.22), 0 0 60px rgba(246,210,122,0.10); }
}

/* Landing pulse (subtle) */
.pulse{
  position:absolute;
  left:50%;
  top: 44%;
  transform: translate(-50%,-50%);
  width:min(420px, 92vw);
  aspect-ratio:1/1;
  border-radius:999px;
  pointer-events:none;
  opacity:0;
  background: radial-gradient(circle, rgba(246,210,122,0.18), transparent 60%);
  filter: drop-shadow(0 25px 90px rgba(246,210,122,0.18));
}
.pulse.show{
  animation: pulsePop 820ms cubic-bezier(.2,.9,.2,1) both;
}
@keyframes pulsePop{
  0%{ opacity:0; transform: translate(-50%,-50%) scale(.92); }
  45%{ opacity:1; transform: translate(-50%,-50%) scale(1.02); }
  100%{ opacity:0; transform: translate(-50%,-50%) scale(1.10); }
}

/* Cups */
.cups{
  display:flex;
  justify-content:center;
  align-items:flex-end;
  gap: 34px;
  margin: 10px 0 18px;
}

.cup{
  width: min(140px, 34vw);
  height: min(140px, 34vw);
  transform-origin: 50% 80%;
  filter: drop-shadow(0 18px 40px rgba(0,0,0,.60));
  animation: floaty 4.4s ease-in-out infinite;
}
.cup:nth-child(2){ animation-delay: -1.8s; }

@keyframes floaty{
  0%{ transform: translateY(0px); }
  50%{ transform: translateY(-6px); }
  100%{ transform: translateY(0px); }
}

.cup img{
  width:100%;
  height:100%;
  object-fit:contain;
  user-select:none;
  -webkit-user-drag:none;
}

/* Cinematic “wind-up” before toss */
.windup{
  animation: windup 260ms ease-out both;
}
@keyframes windup{
  from{ transform: translateY(0) scale(1); }
  to{ transform: translateY(6px) scale(.99); }
}

/* Toss animation with bounce */
.throw{
  animation: toss 1.10s cubic-bezier(.18,.8,.22,1) both !important;
}
@keyframes toss{
  0%   { transform: translateY(0) rotate(0deg) scale(1); }
  18%  { transform: translateY(-18px) rotate(35deg) scale(1.02); }
  45%  { transform: translateY(-86px) rotate(250deg) scale(1.05); }
  72%  { transform: translateY(12px) rotate(360deg) scale(1.0); }
  84%  { transform: translateY(-7px) rotate(360deg) scale(1.0); }
  100% { transform: translateY(0) rotate(360deg) scale(1); }
}

/* Result */
.result{
  margin: 6px 0 2px;
  font-size: 22px;
  font-weight: 800;
  letter-spacing:.12em;
  text-shadow: 0 0 18px rgba(246,210,122,.18);
  min-height: 30px;
}
.result-en{
  margin: 0 0 18px;
  font-size: 13px;
  color: var(--muted);
  letter-spacing:.06em;
  min-height: 18px;
}

/* Button */
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding: 14px 42px;
  border-radius: 999px;
  border:1px solid rgba(246,210,122,0.35);
  background: linear-gradient(45deg, rgba(217,169,75,.92), rgba(246,210,122,.92));
  color: rgba(10,10,14,.95);
  font-weight: 900;
  letter-spacing:.14em;
  box-shadow: var(--shadow);
  cursor:pointer;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
  transition: transform .12s ease, filter .12s ease;
}
.btn:active{ transform: scale(.98); filter: brightness(.98); }

.foot{
  margin-top: 14px;
  font-size: 11px;
  color: rgba(255,255,255,.52);
  letter-spacing:.06em;
}

@media (max-height: 680px){
  .subtitle{ margin-bottom: 18px; }
}
</style>
</head>

<body>
<div class="bg" id="bg"></div>
<div class="overlay"></div>
<div class="mist"></div>

<div class="wrap">
  <div class="stage">
    <h1 class="title">擲筊儀式體驗</h1>
    <p class="subtitle">Jiaobei Divination Experience · Night Ritual</p>

    <div class="ring" id="ring" aria-hidden="true"></div>
    <div class="pulse" id="pulse" aria-hidden="true"></div>

    <div class="cups">
      <div class="cup" id="cup1"></div>
      <div class="cup" id="cup2"></div>
    </div>

    <div class="result" id="result">靜心 · 擲筊</div>
    <div class="result-en" id="resultEn">Center yourself and cast the blocks</div>

    <div class="btn" id="btn">擲筊 · CAST</div>
    <div class="foot">Interactive Ritual UI · Portfolio Edition</div>
  </div>
</div>

<script>
  const cup1 = document.getElementById("cup1");
  const cup2 = document.getElementById("cup2");
  const ring = document.getElementById("ring");
  const pulse = document.getElementById("pulse");
  const result = document.getElementById("result");
  const resultEn = document.getElementById("resultEn");
  const btn = document.getElementById("btn");
  const bg = document.getElementById("bg");

  // Render cups
  function render(aUp, bUp){
    cup1.innerHTML = `<img src="${aUp ? 'jiaobei_up.png' : 'jiaobei_down.png'}" alt="jiaobei">`;
    cup2.innerHTML = `<img src="${bUp ? 'jiaobei_up.png' : 'jiaobei_down.png'}" alt="jiaobei">`;
  }
  render(true,true);

  // Very subtle parallax for cinematic depth
  let px=0, py=0;
  window.addEventListener('pointermove', (e)=>{
    px = (e.clientX / innerWidth) - 0.5;
    py = (e.clientY / innerHeight) - 0.5;
  }, {passive:true});

  function raf(){
    bg.style.transform = `scale(1.06) translate(${px*8}px, ${py*8}px)`;
    requestAnimationFrame(raf);
  }
  raf();

  // Audio (wood landing, multi-hit)
  const audioCtx = (() => {
    try { return new (window.AudioContext || window.webkitAudioContext)(); }
    catch { return null; }
  })();

  function noiseBurst(atTime, dur){
    if(!audioCtx) return;
    const length = Math.floor(audioCtx.sampleRate * dur);
    const buffer = audioCtx.createBuffer(1, length, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<length;i++){
      data[i] = (Math.random()*2-1) * Math.exp(-i/(length/6));
    }
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;

    const hp = audioCtx.createBiquadFilter();
    hp.type = 'highpass';
    hp.frequency.setValueAtTime(900, atTime);

    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.0001, atTime);
    g.gain.exponentialRampToValueAtTime(0.11, atTime + 0.006);
    g.gain.exponentialRampToValueAtTime(0.0001, atTime + dur);

    src.connect(hp); hp.connect(g); g.connect(audioCtx.destination);
    src.start(atTime);
    src.stop(atTime + dur + 0.02);
  }

  function woodTone(atTime, hz, decay){
    if(!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    const bp = audioCtx.createBiquadFilter();

    o.type = 'triangle';
    o.frequency.setValueAtTime(hz, atTime);

    bp.type = 'bandpass';
    bp.frequency.setValueAtTime(hz * 1.25, atTime);
    bp.Q.setValueAtTime(7.5, atTime);

    g.gain.setValueAtTime(0.0001, atTime);
    g.gain.exponentialRampToValueAtTime(0.22, atTime + 0.008);
    g.gain.exponentialRampToValueAtTime(0.0001, atTime + decay);

    o.connect(bp); bp.connect(g); g.connect(audioCtx.destination);
    o.start(atTime);
    o.stop(atTime + decay + 0.02);
  }

  function playWoodLanding(){
    if(!audioCtx) return;
    const t = audioCtx.currentTime + 0.01;
    // 3 hits like bounce
    noiseBurst(t + 0.00, 0.060); woodTone(t + 0.00, 380, 0.12);
    noiseBurst(t + 0.10, 0.050); woodTone(t + 0.10, 320, 0.14);
    noiseBurst(t + 0.22, 0.045); woodTone(t + 0.22, 260, 0.16);
  }

  // Result logic
  function interpret(aUp, bUp){
    if(aUp && bUp) return { zh:"笑筊", en:"Ambiguous · The gods are smiling" };
    if(!aUp && !bUp) return { zh:"陰筊", en:"No · Not granted" };
    return { zh:"聖筊", en:"Yes · Permission granted" };
  }

  function ringOn(){ ring.classList.add("on"); }
  function ringOff(){ ring.classList.remove("on"); }
  function pulsePop(){
    pulse.classList.remove("show");
    void pulse.offsetWidth;
    pulse.classList.add("show");
  }

  let busy = false;

  function throwJiaobei(){
    if(busy) return;
    busy = true;

    if(audioCtx && audioCtx.state === "suspended"){
      audioCtx.resume().catch(()=>{});
    }

    if(navigator.vibrate) navigator.vibrate([18, 24, 18]);

    // “wind-up” + ring appears (your preferred part)
    ringOn();
    cup1.classList.add("windup");
    cup2.classList.add("windup");

    result.textContent = "擲筊中…";
    resultEn.textContent = "Casting…";

    // start toss after wind-up
    setTimeout(()=>{
      cup1.classList.remove("windup");
      cup2.classList.remove("windup");

      cup1.classList.remove("throw"); cup2.classList.remove("throw");
      void cup1.offsetWidth;
      cup1.classList.add("throw");
      cup2.classList.add("throw");

      // shuffle during throw (cinematic realism)
      const t0 = performance.now();
      const shake = setInterval(()=>{
        render(Math.random()<0.5, Math.random()<0.5);
        if(performance.now() - t0 > 650) clearInterval(shake);
      }, 90);

      // landing sound near landing moment
      setTimeout(()=> playWoodLanding(), 700);

      // final settle
      const aUp = Math.random() < 0.5;
      const bUp = Math.random() < 0.5;

      setTimeout(()=>{
        render(aUp, bUp);
        const r = interpret(aUp, bUp);

        pulsePop();
        result.textContent = r.zh;
        resultEn.textContent = r.en;

        setTimeout(()=> ringOff(), 1200);
        busy = false;
      }, 920);

    }, 260);
  }

  btn.addEventListener("click", throwJiaobei);

  // Optional: double-tap anywhere to cast (nice on mobile)
  document.body.addEventListener("dblclick", (e)=>{
    e.preventDefault();
    throwJiaobei();
  }, {passive:false});
</script>
</body>
</html>
